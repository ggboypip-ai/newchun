<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>æ­¤åˆ»çš„æ˜¥èŠ‚ Â· æ”¾é­ç‚®èŠ‚å¥ç‚¹å‡»</title>
  <style>
    :root{
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Helvetica Neue",Arial,sans-serif;
      --bg1:#8B0000; --bg2:#4a0404; --bg3:#1a0505;
      --paper:#fff7ed; --muted:rgba(255,247,237,.72);
      --gold:#ffd700; --gold2:#ffed4e;
      --card-bg:rgba(20, 5, 5, 0.85);
    }
    
    * { box-sizing: border-box; }
    
    body{
      margin:0; color:var(--paper);
      background:
        radial-gradient(ellipse at 20% 30%, rgba(255,215,0,.25) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(255,140,0,.2) 0%, transparent 45%),
        radial-gradient(ellipse at 50% 80%, rgba(255,215,0,.15) 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 40%, var(--bg3) 100%);
      background-attachment: fixed;
      overflow:hidden;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .wrap{
      max-width:800px; margin:0 auto; padding:20px;
      min-height:100vh; display:flex; position:relative; z-index:1;
    }
    
    /* ===== ä¸­å¼ä¼ ç»Ÿè¾¹æ¡†å¡ç‰‡ ===== */
    .card{
      width:100%; margin:auto;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 24px;
      position:relative;
      overflow:visible;
      backdrop-filter: blur(10px);
      box-shadow: 
        0 20px 60px rgba(0,0,0,.5),
        0 0 0 2px rgba(255,215,0,.3),
        0 0 0 6px rgba(139,0,0,.8),
        0 0 0 8px rgba(255,215,0,.4),
        inset 0 0 30px rgba(255,215,0,.05);
    }
    
    /* å››è§’è£…é¥° */
    .card::before,
    .card::after,
    .card-corner-tl,
    .card-corner-tr,
    .card-corner-bl,
    .card-corner-br {
      content: "â–";
      position: absolute;
      width: 32px;
      height: 32px;
      color: var(--gold);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-shadow: 0 0 10px rgba(255,215,0,.5);
      z-index: 10;
    }
    
    .card::before { top: -6px; left: -6px; transform: rotate(0deg); }
    .card::after { top: -6px; right: -6px; transform: rotate(90deg); }
    .card-corner-tl { bottom: -6px; left: -6px; transform: rotate(270deg); }
    .card-corner-tr { bottom: -6px; right: -6px; transform: rotate(180deg); }
    
    /* è¾¹æ¡†èŠ±çº¹ */
    .card-border-top,
    .card-border-bottom,
    .card-border-left,
    .card-border-right {
      position: absolute;
      pointer-events: none;
    }
    
    .card-border-top,
    .card-border-bottom {
      left: 32px; right: 32px;
      height: 2px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,215,0,.8) 10%, 
        rgba(255,215,0,.8) 90%, 
        transparent 100%
      );
    }
    
    .card-border-top { top: -1px; }
    .card-border-bottom { bottom: -1px; }
    
    .card-border-left,
    .card-border-right {
      top: 32px; bottom: 32px;
      width: 2px;
      background: linear-gradient(180deg, 
        transparent 0%, 
        rgba(255,215,0,.8) 10%, 
        rgba(255,215,0,.8) 90%, 
        transparent 100%
      );
    }
    
    .card-border-left { left: -1px; }
    .card-border-right { right: -1px; }
    
    /* å†…éƒ¨è£…é¥°çº¿ */
    .card-inner-frame {
      position: absolute;
      inset: 12px;
      border: 1px solid rgba(255,215,0,.15);
      border-radius: 4px;
      pointer-events: none;
    }
    
    .card-inner-frame::before {
      content: '';
      position: absolute;
      inset: 4px;
      border: 1px dashed rgba(255,215,0,.1);
      border-radius: 2px;
    }

    h1,h2{ margin:0 0 12px; line-height:1.2; position:relative; z-index:2; font-weight: 600; letter-spacing: 2px; }
    h1 { font-size: 26px; text-shadow: 0 2px 4px rgba(0,0,0,.3); }
    p{ margin:10px 0; color:rgba(255,247,237,.9); position:relative; z-index:2; line-height: 1.6; }
    .muted{ color:var(--muted); font-size:13px; position:relative; z-index:2; }
    
    .row{ 
      display:flex; justify-content:space-between; align-items:center; gap:10px; 
      position:relative; z-index:2; flex-wrap:wrap;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,215,0,.1);
      margin-bottom: 16px;
    }
    
    .badge{
      display:inline-flex; gap:6px; align-items:center; padding:6px 12px;
      border-radius:4px; 
      background: linear-gradient(135deg, rgba(139,0,0,.6) 0%, rgba(74,4,4,.6) 100%);
      border:1px solid rgba(255,215,0,.3); 
      font-size:12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    
    .btns{ display:grid; gap:12px; margin-top:16px; position:relative; z-index:2; }
    
    button{
      appearance:none; border:0; border-radius:6px; padding:14px 18px;
      font-size:16px; font-weight:600; cursor:pointer;
      background: linear-gradient(135deg, rgba(255,215,0,.15) 0%, rgba(255,215,0,.05) 100%);
      color:var(--paper);
      border:1px solid rgba(255,215,0,.4);
      text-align:left;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,215,0,.2), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover {
      border-color: rgba(255,215,0,.7);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255,215,0,.2);
    }
    
    button:active{ transform:scale(.98) translateY(0); background: rgba(255,215,0,.2); }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; position:relative; z-index:2;}
    
    .small{ 
      padding:10px 14px; 
      border-radius:4px; 
      font-size:13px; 
      font-weight:600;
      background: rgba(255,247,237,.08);
    }

    /* ===== æ˜¥èŠ‚åœºæ™¯è£…é¥° ===== */
    .scene{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .sparks{
      position:absolute; inset:0; opacity:.4;
      background-image:
        radial-gradient(circle at 10% 30%, rgba(255,215,0,.35) 0 2px, transparent 3px),
        radial-gradient(circle at 65% 18%, rgba(255,140,0,.35) 0 2px, transparent 3px),
        radial-gradient(circle at 82% 62%, rgba(255,215,0,.28) 0 2px, transparent 3px),
        radial-gradient(circle at 30% 74%, rgba(255,140,0,.28) 0 2px, transparent 3px);
      animation: sparkle 6s ease-in-out infinite;
    }
    @keyframes sparkle{0%,100%{transform:translateY(0);opacity:.35}50%{transform:translateY(-8px);opacity:.55}}

    .lantern{
      position:absolute; top:-10px; width:80px; height:130px;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.4));
      opacity:.9; 
      transform-origin: top center;
      animation: sway 5s ease-in-out infinite;
      z-index: 5;
    }
    .lantern.l1{ left:20px; animation-duration:5.2s; }
    .lantern.l2{ right:20px; animation-duration:4.8s; animation-direction:reverse; }
    @keyframes sway{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}

    /* çƒŸèŠ±åŠ¨ç”» */
    .firework{
      position:absolute;
      width:3px;
      height:3px;
      border-radius:50%;
      animation: launch 2.5s ease-out infinite;
    }
    @keyframes launch{
      0% { transform: translateY(100vh) scale(1); opacity:1; }
      50% { opacity:1; }
      100% { transform: translateY(25vh) scale(0); opacity:0; }
    }
    .firework::before,
    .firework::after{
      content:'';
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      border-radius:50%;
      animation: explode 1.2s ease-out infinite;
    }
    .firework::before{
      box-shadow: 
        0 -20px 0 -2px #ffd700,
        14px -14px 0 -2px #ff6b6b,
        20px 0 0 -2px #4ecdc4,
        14px 14px 0 -2px #ffe66d,
        0 20px 0 -2px #ff8c42,
        -14px 14px 0 -2px #ff6b9d,
        -20px 0 0 -2px #c7f464,
        -14px -14px 0 -2px #ffd93d;
    }
    .firework::after{
      animation-delay:0.1s;
      box-shadow: 
        0 -30px 0 -4px rgba(255,215,0,.8),
        21px -21px 0 -4px rgba(255,107,107,.8),
        30px 0 0 -4px rgba(78,205,196,.8),
        21px 21px 0 -4px rgba(255,230,109,.8),
        0 30px 0 -4px rgba(255,140,66,.8),
        -21px 21px 0 -4px rgba(255,107,157,.8),
        -30px 0 0 -4px rgba(199,244,100,.8),
        -21px -21px 0 -4px rgba(255,217,61,.8);
    }
    @keyframes explode{
      0% { transform: scale(0); opacity:1; }
      50% { opacity:1; }
      100% { transform: scale(3); opacity:0; }
    }

    /* å°äººè§’è‰² */
    .character{
      position:absolute;
      bottom:30px;
      width:50px;
      height:70px;
      animation: bounce 0.9s ease-in-out infinite;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.3));
    }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-8px); }
    }
    .character .head{
      width:26px;
      height:26px;
      background: #ffdbac;
      border-radius:50%;
      margin:0 auto;
      position:relative;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    .character .head::before,
    .character .head::after{
      content:'';
      position:absolute;
      width:3px;
      height:3px;
      background:#333;
      border-radius:50%;
      top:9px;
    }
    .character .head::before{ left:7px; }
    .character .head::after{ right:7px; }
    .character .head .mouth{
      position:absolute;
      width:8px;
      height:4px;
      border-bottom:2px solid #e74c3c;
      border-radius:0 0 8px 8px;
      bottom:5px;
      left:50%;
      transform:translateX(-50%);
    }
    .character .body{
      width:34px;
      height:30px;
      background: #e74c3c;
      margin:2px auto 0;
      border-radius:8px 8px 4px 4px;
      position:relative;
    }
    .character .body::before,
    .character .body::after{
      content:'';
      position:absolute;
      width:10px;
      height:20px;
      background: #ffdbac;
      top:4px;
      border-radius:8px;
    }
    .character .body::before{ left:-6px; animation: wave-left 1.2s ease-in-out infinite; }
    .character .body::after{ right:-6px; animation: wave-right 1.2s ease-in-out infinite; }
    @keyframes wave-left{
      0%,100%{ transform: rotate(-15deg); }
      50%{ transform: rotate(-35deg); }
    }
    @keyframes wave-right{
      0%,100%{ transform: rotate(15deg); }
      50%{ transform: rotate(35deg); }
    }
    .character .legs{
      display:flex;
      justify-content:center;
      gap:4px;
      margin-top:-3px;
    }
    .character .legs::before,
    .character .legs::after{
      content:'';
      width:10px;
      height:16px;
      background: #2c3e50;
      border-radius:0 0 4px 4px;
    }
    .character.char1{ left:8%; animation-delay:0s; }
    .character.char2{ left:18%; animation-delay:0.3s; }
    .character.char3{ right:18%; animation-delay:0.6s; }
    .character.char4{ right:8%; animation-delay:0.9s; }

    .banner{
      position:absolute; top:80px; left:50%; transform:translateX(-50%);
      padding:8px 20px; 
      border-radius:4px;
      background: linear-gradient(135deg, rgba(139,0,0,.9) 0%, rgba(74,4,4,.9) 100%);
      border:1px solid rgba(255,215,0,.4);
      box-shadow: 0 4px 15px rgba(0,0,0,.3);
      font-weight:700; 
      letter-spacing:3px;
      font-size: 14px;
      color: var(--gold);
      z-index: 5;
    }
    
    @media (max-width: 600px){ 
      .character{ transform:scale(0.8); bottom:20px; }
      .character.char2{ left:15%; }
      .character.char3{ right:15%; }
      .banner{top:60px; font-size: 12px; padding: 6px 14px;} 
      .card { padding: 18px; }
      h1 { font-size: 22px; }
    }

    /* ===== æ¸¸æˆèˆå° ===== */
    .stage{
      margin-top:16px;
      background: rgba(0,0,0,.2);
      border:1px solid rgba(255,215,0,.15);
      border-radius:8px;
      padding:16px;
      position:relative; z-index:2;
      box-shadow: inset 0 2px 10px rgba(0,0,0,.2);
    }
    
    canvas{
      width:100%;
      height:340px;
      display:block;
      border-radius:6px;
      background: rgba(0,0,0,.3);
      border:1px solid rgba(255,215,0,.1);
    }
    
    @media (max-width: 600px){
      canvas{ height:380px; }
    }

    .hud{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin:12px 0 0; position:relative; z-index:2;
    }
    .hud .box{
      flex: 1;
      min-width: 80px;
      padding:10px; 
      border-radius:6px;
      background: rgba(255,215,0,.08);
      border: 1px solid rgba(255,215,0,.15);
      text-align: center;
    }
    .big{
      font-size:20px; 
      font-weight:800;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(255,215,0,.3);
    }

    /* confetti */
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:50; overflow:hidden; }
    .confetti i{ position:absolute; top:-10px; width:10px; height:14px; border-radius:3px; opacity:.9; animation: fall 1.2s linear forwards; }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(120deg); opacity:.95 } }

    textarea{
      width:100%; min-height:100px; margin-top:12px; padding:12px;
      border-radius:6px; background:rgba(255,247,237,.08);
      border:1px solid rgba(255,215,0,.2); 
      color:rgba(255,247,237,.92);
      resize:vertical; 
      box-sizing:border-box; 
      outline:none;
      position:relative; z-index:2;
      font-family: inherit;
    }
    
    textarea:focus {
      border-color: rgba(255,215,0,.4);
      background: rgba(255,247,237,.12);
    }
  </style>
</head>

<body>
  <div class="scene" aria-hidden="true">
    <div class="sparks"></div>

    <!-- çƒŸèŠ± -->
    <div class="firework" style="left:12%; animation-delay:0s;"></div>
    <div class="firework" style="left:28%; animation-delay:0.6s; animation-duration:2.8s;"></div>
    <div class="firework" style="left:72%; animation-delay:1.2s; animation-duration:2.2s;"></div>
    <div class="firework" style="left:88%; animation-delay:0.4s;"></div>
    <div class="firework" style="left:45%; animation-delay:1.8s; animation-duration:2.5s;"></div>
    <div class="firework" style="left:55%; animation-delay:0.9s; animation-duration:3s;"></div>

    <!-- å°äººè§’è‰² -->
    <div class="character char1">
      <div class="head"><div class="mouth"></div></div>
      <div class="body"></div>
      <div class="legs"></div>
    </div>
    <div class="character char2">
      <div class="head"><div class="mouth"></div></div>
      <div class="body" style="background:#3498db;"></div>
      <div class="legs"></div>
    </div>
    <div class="character char3">
      <div class="head"><div class="mouth"></div></div>
      <div class="body" style="background:#2ecc71;"></div>
      <div class="legs"></div>
    </div>
    <div class="character char4">
      <div class="head"><div class="mouth"></div></div>
      <div class="body" style="background:#9b59b6;"></div>
      <div class="legs"></div>
    </div>

    <svg class="lantern l1" viewBox="0 0 120 190">
      <path d="M60 0 C58 12,58 12,60 24" stroke="rgba(255,247,237,.7)" stroke-width="3" fill="none"/>
      <circle cx="60" cy="28" r="9" fill="rgba(255,215,0,.75)" stroke="rgba(255,247,237,.35)"/>
      <path d="M35 40 C20 70,20 120,35 150 C50 175,70 175,85 150 C100 120,100 70,85 40 C70 20,50 20,35 40Z"
            fill="rgba(139,0,0,.95)" stroke="rgba(255,215,0,.4)" stroke-width="2"/>
      <path d="M45 48 C35 74,35 116,45 142" stroke="rgba(255,215,0,.3)" stroke-width="3" fill="none"/>
      <path d="M75 48 C85 74,85 116,75 142" stroke="rgba(255,215,0,.3)" stroke-width="3" fill="none"/>
      <rect x="44" y="148" width="32" height="14" rx="6" fill="rgba(255,215,0,.75)" stroke="rgba(255,247,237,.25)"/>
    </svg>

    <svg class="lantern l2" viewBox="0 0 120 190">
      <path d="M60 0 C58 12,58 12,60 24" stroke="rgba(255,247,237,.7)" stroke-width="3" fill="none"/>
      <circle cx="60" cy="28" r="9" fill="rgba(255,215,0,.75)" stroke="rgba(255,247,237,.35)"/>
      <path d="M35 40 C20 70,20 120,35 150 C50 175,70 175,85 150 C100 120,100 70,85 40 C70 20,50 20,35 40Z"
            fill="rgba(139,0,0,.95)" stroke="rgba(255,215,0,.4)" stroke-width="2"/>
      <path d="M45 48 C35 74,35 116,45 142" stroke="rgba(255,215,0,.3)" stroke-width="3" fill="none"/>
      <path d="M75 48 C85 74,85 116,75 142" stroke="rgba(255,215,0,.3)" stroke-width="3" fill="none"/>
      <rect x="44" y="148" width="32" height="14" rx="6" fill="rgba(255,215,0,.75)" stroke="rgba(255,247,237,.25)"/>
    </svg>

    <div class="banner">ğŸ§¨ æ”¾é­ç‚® Â· å¹´å‘³æ‹‰æ»¡ ğŸ§¨</div>
  </div>

  <div class="wrap">
    <div class="card" id="app">
      <!-- å››è§’è£…é¥°å…ƒç´  -->
      <div class="card-corner-tl"></div>
      <div class="card-corner-tr"></div>
      
      <!-- è¾¹æ¡†çº¿æ¡ -->
      <div class="card-border-top"></div>
      <div class="card-border-bottom"></div>
      <div class="card-border-left"></div>
      <div class="card-border-right"></div>
      
      <!-- å†…éƒ¨è£…é¥°æ¡† -->
      <div class="card-inner-frame"></div>
    </div>
  </div>

  <script>
    // =============================
    // éŸ³é¢‘ï¼šèŠ‚æ‹ + çˆ†ç«¹éŸ³æ•ˆï¼ˆä¸ä¾èµ–å¤–éƒ¨èµ„æºï¼‰
    // =============================
    const AudioSys = (() => {
      let ctx=null, master=null, on=false;

      function init(){
        if(ctx) return;
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        master = ctx.createGain();
        master.gain.value = 0.18;
        master.connect(ctx.destination);
      }

      function setOn(v){
        init();
        on = v;
        if(ctx.state === "suspended") ctx.resume();
      }

      function toggle(){
        setOn(!on);
        return on;
      }

      function clickSound(t){
        if(!on) return;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type="square";
        osc.frequency.setValueAtTime(900, t);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.18, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.05);
        osc.connect(g); g.connect(master);
        osc.start(t); osc.stop(t+0.06);
      }

      function firecracker(t, intensity=1){
        if(!on) return;
        const bufferSize = Math.floor(ctx.sampleRate * 0.12);
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0;i<bufferSize;i++){
          const env = Math.exp(-i/(ctx.sampleRate*0.02));
          data[i] = (Math.random()*2-1) * env * (0.9 + 0.2*Math.random());
        }
        const src = ctx.createBufferSource();
        src.buffer = buffer;

        const bp = ctx.createBiquadFilter();
        bp.type="bandpass";
        bp.frequency.setValueAtTime(1400, t);
        bp.Q.setValueAtTime(0.8, t);

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.35*intensity, t+0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.11);

        src.connect(bp); bp.connect(g); g.connect(master);
        src.start(t); src.stop(t+0.12);
      }

      function isOn(){ return on; }
      function time(){ return ctx ? ctx.currentTime : 0; }

      return { init, setOn, toggle, isOn, clickSound, firecracker, time };
    })();

    const CFG = {
      bpm: 100,
      durationSec: 45,
      perfectMs: 80,
      goodMs: 150,
      leadBeats: 2,
    };

    function generateBeatTimes(startTimeSec){
      const beat = 60 / CFG.bpm;
      const step = beat/2;
      const totalSteps = Math.floor(CFG.durationSec / step);
      const times = [];
      for(let i=0;i<totalSteps;i++){
        const inBar = i % 8;
        let spawn = false;
        if(inBar === 0 || inBar === 2 || inBar === 4 || inBar === 6) spawn = true;
        if(Math.random() < 0.10 && (inBar===1 || inBar===3 || inBar===5 || inBar===7)) spawn = true;
        if(Math.random() < 0.06) spawn = false;
        if(spawn) times.push(startTimeSec + i*step);
      }
      return times;
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    class Particle{
      constructor(x,y,vx,vy,life,color){
        this.x=x; this.y=y; this.vx=vx; this.vy=vy;
        this.life=life; this.max=life; this.color=color;
      }
      step(dt){
        this.vy += 680*dt;
        this.x += this.vx*dt;
        this.y += this.vy*dt;
        this.life -= dt;
      }
      draw(ctx){
        const alpha = clamp(this.life/this.max,0,1);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 3, 3);
        ctx.globalAlpha = 1;
      }
    }

    const app = document.getElementById("app");
    let state = "menu";
    let canvas, ctx, W, H, dpr;
    let startAt = 0;
    let beatTimes = [];
    let nextBeatIndex = 0;
    let score = 0;
    let combo = 0;
    let maxCombo = 0;
    let perfect = 0, good = 0, miss = 0;
    let particles = [];
    let lastFrame = 0;
    let running = false;

    function popConfetti(n=40){
      const layer = document.createElement("div");
      layer.className="confetti";
      const colors=["rgba(255,215,0,.95)","rgba(255,140,0,.95)","rgba(255,247,237,.90)","rgba(139,0,0,.85)"];
      for(let i=0;i<n;i++){
        const p=document.createElement("i");
        p.style.left=(Math.random()*100)+"vw";
        p.style.animationDelay=(Math.random()*0.25)+"s";
        p.style.animationDuration=(0.9+Math.random()*0.7)+"s";
        const size=8+Math.random()*10;
        p.style.width=(size*0.7)+"px";
        p.style.height=size+"px";
        p.style.background=colors[Math.floor(Math.random()*colors.length)];
        layer.appendChild(p);
      }
      document.body.appendChild(layer);
      setTimeout(()=>layer.remove(), 1800);
    }

    function vibrate(ms){
      try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){}
    }

    function renderMenu(){
      state="menu";
      running=false;
      app.innerHTML += `
        <div class="row">
          <div class="badge">ğŸ§¨ èŠ‚å¥ç‚¹å‡»</div>
          <div class="badge">ğŸ® æ˜¥èŠ‚æ°›å›´</div>
          <div class="badge">â±ï¸ ${CFG.durationSec}s</div>
        </div>
        <h1 style="margin-top:8px; text-align:center;">æ­¤åˆ»çš„æ˜¥èŠ‚ Â· æ”¾é­ç‚®</h1>
        <p style="text-align:center; margin-bottom:20px;">è·Ÿç€èŠ‚å¥ç‚¹ç«å¼•çˆ†ã€‚è¶Šå‡†ã€è¿å‡»è¶Šé«˜ï¼Œå¹´å‘³è¶Š"æ‹‰æ»¡"ã€‚</p>
        <div class="stage">
          <p class="muted">æ“ä½œæŒ‡å—ï¼š</p>
          <p class="muted">â€¢ æ‰‹æœºï¼šç‚¹å‡»å±å¹•ä»»æ„ä½ç½®ï¼ˆæˆ–ç‚¹é­ç‚®ï¼‰</p>
          <p class="muted">â€¢ ç”µè„‘ï¼šç©ºæ ¼ / é¼ æ ‡ç‚¹å‡»</p>
          <p class="muted">æç¤ºï¼šéŸ³ä¹/éŸ³æ•ˆéœ€ç‚¹å‡»åæ‰èƒ½æ’­æ”¾ï¼ˆæµè§ˆå™¨è§„åˆ™ï¼‰ã€‚</p>
          <div class="btns">
            <button id="startBtn">â–¶ å¼€å§‹æ”¾é­ç‚®</button>
          </div>
          <div class="toolbar">
            <button class="small" id="audioBtn">ğŸµ éŸ³æ•ˆï¼š${AudioSys.isOn() ? "å¼€" : "å…³"}</button>
            <button class="small" id="howBtn">ğŸ“Œ ç©æ³•è¯´æ˜</button>
          </div>
        </div>
        <p class="muted" style="margin-top:16px; text-align:center;">æ„¿è¿™ä¸€åˆ»ï¼Œè¢«å¥½å¥½è®°ä½ã€‚</p>
      `;

      document.getElementById("startBtn").onclick = async () => {
        AudioSys.init();
        AudioSys.setOn(true);
        renderPlay();
      };
      document.getElementById("audioBtn").onclick = () => {
        const on = AudioSys.toggle();
        document.getElementById("audioBtn").textContent = `ğŸµ éŸ³æ•ˆï¼š${on ? "å¼€" : "å…³"}`;
      };
      document.getElementById("howBtn").onclick = () => {
        alert("ç©æ³•ï¼šç‚¹ç«åœˆç¼©åˆ°å‘½ä¸­çº¿æ—¶ç‚¹å‡»/ç©ºæ ¼ã€‚\nPerfectï¼ˆæ›´å‡†ï¼‰> Good > Missã€‚\nè¿å‡»è¶Šé«˜ï¼Œå¹´å‘³è¶Šè¶³ï¼");
      };
    }

    function renderPlay(){
      state="play";
      score=0; combo=0; maxCombo=0; perfect=0; good=0; miss=0;
      particles=[]; nextBeatIndex=0;

      // æ¸…ç©ºå¹¶ä¿ç•™è£…é¥°å…ƒç´ 
      const decorations = app.querySelectorAll('.card-border-top, .card-border-bottom, .card-border-left, .card-border-right, .card-corner-tl, .card-corner-tr, .card-inner-frame');
      app.innerHTML = '';
      decorations.forEach(el => app.appendChild(el));
      
      app.innerHTML += `
        <div class="row">
          <div class="badge">ğŸ§¨ æ”¾é­ç‚®è¿›è¡Œä¸­</div>
          <div class="badge" id="timeBadge">â±ï¸ ${CFG.durationSec}s</div>
          <div class="badge" id="judgeBadge">Ready</div>
        </div>

        <div class="stage">
          <canvas id="c"></canvas>
          <div class="hud">
            <div class="box"><div class="muted">Score</div><div class="big" id="scoreV">0</div></div>
            <div class="box"><div class="muted">Combo</div><div class="big" id="comboV">0</div></div>
            <div class="box"><div class="muted">Accuracy</div><div class="big" id="accV">0%</div></div>
          </div>

          <div class="toolbar">
            <button class="small" id="audioBtn">ğŸµ éŸ³æ•ˆï¼š${AudioSys.isOn() ? "å¼€" : "å…³"}</button>
            <button class="small" id="quitBtn">â¹ ç»“æŸ</button>
          </div>

          <p class="muted" style="text-align:center; margin-top:8px;">ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æˆ–æŒ‰ç©ºæ ¼ã€‚è¶Šå‡†è¶Šçˆ½ã€‚</p>
        </div>
      `;

      canvas = document.getElementById("c");
      ctx = canvas.getContext("2d");
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas, { passive:true });

      document.getElementById("audioBtn").onclick = () => {
        const on = AudioSys.toggle();
        document.getElementById("audioBtn").textContent = `ğŸµ éŸ³æ•ˆï¼š${on ? "å¼€" : "å…³"}`;
      };
      document.getElementById("quitBtn").onclick = () => endGame();

      const onHit = () => handleHit();
      window.onkeydown = (e) => { if(e.code==="Space"){ e.preventDefault(); onHit(); } };
      canvas.onclick = onHit;
      canvas.ontouchstart = (e) => { e.preventDefault(); onHit(); };

      startAt = AudioSys.time() + 0.75;
      beatTimes = generateBeatTimes(startAt);
      running = true;
      lastFrame = performance.now();
      requestAnimationFrame(loop);
    }

    function resizeCanvas(){
      if(!canvas) return;
      dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      W = Math.floor(rect.width * dpr);
      H = Math.floor(rect.height * dpr);
      canvas.width = W; canvas.height = H;
    }

    function nowAudio(){ return AudioSys.time(); }

    function calcAcc(){
      const total = perfect + good + miss;
      if(total<=0) return 0;
      const pts = perfect*1 + good*0.6 + miss*0;
      return Math.round((pts/total)*100);
    }

    function setJudge(text){
      const el = document.getElementById("judgeBadge");
      if(el) el.textContent = text;
    }

    function updateHUD(){
      const s = document.getElementById("scoreV");
      const c = document.getElementById("comboV");
      const a = document.getElementById("accV");
      if(s) s.textContent = String(score);
      if(c) c.textContent = String(combo);
      if(a) a.textContent = `${calcAcc()}%`;
    }

    function handleHit(){
      if(!running) return;
      const t = nowAudio();

      let bestIdx = -1;
      let bestDt = Infinity;

      for(let k=0;k<3;k++){
        const i = nextBeatIndex + k;
        if(i < 0 || i >= beatTimes.length) continue;
        const dt = Math.abs((t - beatTimes[i]) * 1000);
        if(dt < bestDt){
          bestDt = dt;
          bestIdx = i;
        }
      }

      if(bestIdx === -1){
        registerMiss("Miss");
        return;
      }

      if(bestDt <= CFG.perfectMs){
        registerHit("Perfect", bestIdx, 120);
      }else if(bestDt <= CFG.goodMs){
        registerHit("Good", bestIdx, 70);
      }else{
        registerMiss("Miss");
      }
    }

    function registerHit(type, beatIdx, base){
      if(beatIdx === nextBeatIndex) nextBeatIndex++;
      else if(beatIdx > nextBeatIndex) nextBeatIndex = beatIdx + 1;

      if(type==="Perfect"){ perfect++; AudioSys.firecracker(nowAudio()+0.01, 1.0); vibrate(12); }
      else { good++; AudioSys.firecracker(nowAudio()+0.01, 0.8); vibrate(8); }

      combo++;
      maxCombo = Math.max(maxCombo, combo);
      const add = Math.floor(base + combo*2);
      score += add;

      setJudge(type);
      spawnBurst(type);
      updateHUD();
    }

    function registerMiss(type){
      miss++;
      combo = 0;
      setJudge(type);
      if(AudioSys.isOn()){
        AudioSys.clickSound(nowAudio()+0.01);
      }
      updateHUD();
    }

    function spawnBurst(type){
      const x = W*0.5;
      const y = H*0.62;
      const colors = type==="Perfect"
        ? ["rgba(255,215,0,.95)","rgba(255,140,0,.95)","rgba(255,247,237,.90)"]
        : ["rgba(255,140,0,.90)","rgba(255,247,237,.80)"];
      const n = type==="Perfect" ? 28 : 18;
      for(let i=0;i<n;i++){
        const ang = Math.random()*Math.PI*2;
        const sp = (type==="Perfect" ? 260 : 200) + Math.random()*220;
        const vx = Math.cos(ang)*sp;
        const vy = Math.sin(ang)*sp - 120;
        const life = 0.55 + Math.random()*0.45;
        particles.push(new Particle(x, y, vx, vy, life, colors[Math.floor(Math.random()*colors.length)]));
      }
    }

    function drawStage(t){
      ctx.clearRect(0,0,W,H);

      const cx = W*0.5;
      const top = H*0.14;
      const ropeY = top + H*0.06;

      ctx.save();
      ctx.globalAlpha = 0.85;
      ctx.strokeStyle = "rgba(255,247,237,.65)";
      ctx.lineWidth = 3*dpr;
      ctx.beginPath();
      ctx.moveTo(cx - W*0.22, ropeY);
      ctx.quadraticCurveTo(cx, ropeY - H*0.03, cx + W*0.22, ropeY);
      ctx.stroke();

      const count = 10;
      const startX = cx - W*0.22;
      const gap = (W*0.44)/(count-1);
      for(let i=0;i<count;i++){
        const x = startX + i*gap;
        const h = H*0.20 + (i%2)*H*0.06;
        const y = ropeY + H*0.03;
        ctx.fillStyle = "rgba(139,0,0,.95)";
        roundRect(ctx, x-10*dpr, y, 20*dpr, h, 8*dpr);
        ctx.fill();
        ctx.fillStyle = "rgba(255,215,0,.78)";
        roundRect(ctx, x-10*dpr, y, 20*dpr, 10*dpr, 6*dpr);
        ctx.fill();
        ctx.strokeStyle = "rgba(255,247,237,.18)";
        ctx.lineWidth = 2*dpr;
        ctx.beginPath();
        ctx.moveTo(x-4*dpr, y+16*dpr);
        ctx.lineTo(x-4*dpr, y+h-10*dpr);
        ctx.stroke();
      }
      ctx.restore();

      const targetY = H*0.62;
      ctx.strokeStyle = "rgba(255,247,237,.35)";
      ctx.lineWidth = 2*dpr;
      ctx.beginPath();
      ctx.moveTo(cx - W*0.18, targetY);
      ctx.lineTo(cx + W*0.18, targetY);
      ctx.stroke();

      const beat = 60/CFG.bpm;
      const lead = CFG.leadBeats * beat;
      const current = t;

      for(let i=nextBeatIndex;i<beatTimes.length;i++){
        const bt = beatTimes[i];
        const dt = bt - current;
        if(dt < - (CFG.goodMs/1000)) {
          miss++;
          combo = 0;
          nextBeatIndex = i+1;
          setJudge("Miss");
          updateHUD();
          continue;
        }
        if(dt > lead) break;

        const p = clamp(1 - dt/lead, 0, 1);
        const r = lerp(H*0.20, H*0.03, p);
        const alpha = 0.18 + p*0.55;

        ctx.globalAlpha = alpha;
        ctx.strokeStyle = "rgba(255,215,0,.85)";
        ctx.lineWidth = (3 + p*3) * dpr;
        ctx.beginPath();
        ctx.arc(cx, targetY, r, 0, Math.PI*2);
        ctx.stroke();
        ctx.globalAlpha = 1;
      }

      const dt = Math.min(0.033, (performance.now()-lastFrame)/1000);
      for(let i=particles.length-1;i>=0;i--){
        particles[i].step(dt);
        particles[i].draw(ctx);
        if(particles[i].life <= 0) particles.splice(i,1);
      }
    }

    function loop(){
      if(!running) return;
      const now = performance.now();
      const dt = Math.min(0.05, (now - lastFrame)/1000);
      lastFrame = now;

      const t = nowAudio();
      const remain = Math.max(0, (startAt + CFG.durationSec) - t);
      const badge = document.getElementById("timeBadge");
      if(badge) badge.textContent = `â±ï¸ ${remain.toFixed(1)}s`;

      drawStage(t);

      if(remain <= 0){
        endGame();
        return;
      }

      requestAnimationFrame(loop);
    }

    function endGame(){
      if(!running) return;
      running=false;
      window.onkeydown = null;

      const acc = calcAcc();
      const vibe = clamp(Math.round(acc*0.7 + (maxCombo*3)), 0, 100);
      const total = perfect + good + miss;
      const shareText =
`æˆ‘åˆšç©äº†ã€Šæ­¤åˆ»çš„æ˜¥èŠ‚ Â· æ”¾é­ç‚®ã€‹ğŸ§¨
å¹´å‘³æŒ‡æ•°ï¼š${vibe}/100
Scoreï¼š${score}  æœ€é«˜è¿å‡»ï¼š${maxCombo}
Perfectï¼š${perfect}  Goodï¼š${good}  Missï¼š${miss}

ä½ ä¹Ÿæ¥ç‚¹ä¸¤ä¸‹ï¼Œå¬ä¸ªå“ã€‚`;

      renderResult({ acc, vibe, total, shareText });
    }

    function renderResult({acc, vibe, total, shareText}){
      state="result";
      popConfetti(70);

      const decorations = app.querySelectorAll('.card-border-top, .card-border-bottom, .card-border-left, .card-border-right, .card-corner-tl, .card-corner-tr, .card-inner-frame');
      app.innerHTML = '';
      decorations.forEach(el => app.appendChild(el));
      
      app.innerHTML += `
        <div class="row">
          <div class="badge">ğŸ† ç»“ç®—</div>
          <div class="badge">å¹´å‘³æŒ‡æ•°ï¼š${vibe}/100</div>
          <div class="badge">Accuracyï¼š${acc}%</div>
        </div>
        <h1 style="margin-top:8px; text-align:center;">ä½ ç‚¹å‡ºäº†ä¸€ä¸ª"${vibe>=80?"çˆ†ç‚¸å¹´å‘³":"ç¨³ç¨³å¹´å‘³"}"çš„æ˜¥èŠ‚</h1>
        <p class="muted" style="text-align:center; margin-bottom:16px;">Scoreï¼š${score} ï½œæœ€é«˜è¿å‡»ï¼š${maxCombo} ï½œPerfect ${perfect} / Good ${good} / Miss ${miss}</p>

        <div class="stage">
          <div class="btns">
            <button id="copyBtn">ğŸ“‹ å¤åˆ¶åˆ†äº«æ–‡æ¡ˆ</button>
            <button id="againBtn">ğŸ” å†æ¥ä¸€å±€</button>
            <button id="menuBtn">ğŸ® å›åˆ°é¦–é¡µ</button>
          </div>
          <p class="muted" id="msg" style="margin-top:12px; text-align:center;"></p>
          <div id="fallback" style="display:none;">
            <p class="muted" style="margin-top:10px; text-align:center;">è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶ä¸‹é¢æ–‡å­—</p>
            <textarea id="ta" readonly></textarea>
          </div>
        </div>

        <p class="muted" style="text-align:center; margin-top:16px;">æ„¿è¿™ä¸€åˆ»ï¼Œè¢«å¥½å¥½è®°ä½ã€‚</p>
      `;

      document.getElementById("againBtn").onclick = () => { popConfetti(24); renderPlay(); };
      document.getElementById("menuBtn").onclick = () => location.reload();

      document.getElementById("copyBtn").onclick = async () => {
        const msg = document.getElementById("msg");
        const fb = document.getElementById("fallback");
        const ta = document.getElementById("ta");
        try{
          await navigator.clipboard.writeText(shareText);
          fb.style.display="none";
          msg.innerHTML = `<span style="color:#ffd700;font-weight:800;">å·²å¤åˆ¶ï¼</span> å»æœ‹å‹åœˆ/ç¾¤é‡Œç²˜è´´å°±è¡Œã€‚`;
        }catch(e){
          ta.value = shareText;
          fb.style.display="block";
          msg.textContent = "å¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨æƒé™é™åˆ¶ï¼‰ã€‚å·²å±•å¼€æ‰‹åŠ¨å¤åˆ¶æ¡†ã€‚";
          setTimeout(()=>{ ta.focus(); ta.select(); }, 80);
        }
      };
    }

    function lerp(a,b,t){ return a + (b-a)*t; }
    function roundRect(ctx,x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    renderMenu();
  </script>
</body>
</html>
